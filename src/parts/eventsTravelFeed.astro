---
import SVG from "@parts/svg";

const api = import.meta.env.API_URL;
---

<section id="where" class="where">
	<div class="background">
		<SVG name="graphics/blob_hexagon.svg" class="hexagon blob" />
	</div>
	<div class="summary">
		<SVG name="graphics/globe.svg" class="globe" />
		<h2>Where is Amy?</h2>
		<p class="current">
			Right now Amy is in <span class="location"
				><img alt="" src="/img/countries/au.svg" /> Perth, Australia</span
			>
			<span class="conference"></span>
		</p>
	</div>
	<SVG name="graphics/squiggle.svg" class="squiggle" />
	<a class="top" href="#main">
		<SVG name="graphics/arrow.svg" class="arrow_blob" />
		<span class="sr-only">Back to top</span>
	</a>
	<h3 class="sr-only">Coming Up Next</h3>
	<div class="upcoming">
		<h4>Trips</h4>
		<div class="trips">
			<p>Loading upcoming trips</p>
		</div>
		<h4>Events</h4>
		<div class="conferences">
			<p>Loading upcoming events</p>
		</div>
	</div>
</section>

<script define:vars={{ api }}>
	const slugify = (string) => string.toLowerCase().replace(" ", "-");
	const icons = {
		speaking: {
			img: "mic",
			alt: "speaking",
		},
		organising: {
			img: "notes",
			alt: "organising",
		},
		attending: {
			img: "badge",
			alt: "",
		},
		workshop: {
			img: "presentation",
			alt: "running a workshop",
		},
	};

	console.log("running script 3");

	if (typeof document !== "undefined") {
		console.log("running script 2");
		const section = document.querySelector("#where");

		console.log("running script");

		if (section) {
			const location = section.querySelector(".location");
			const currentConference = section.querySelector(".conference");
			const trips = section.querySelector(".trips");
			const conferences = section.querySelector(".conferences");

			fetch(`${api}/events`)
				.then((res) => res.json())
				.then((res) => {
					if (res.length) {
						conferences.innerHTML = "<ul></ul>";

						const conferenceList = conferences.querySelector("ul");
						const eventItems = res.map(
							({ type, name, start, end, url }) => {
								const svgs = type
									?.map(
										(t) =>
											`<img alt="${type} icon" src="/img/icons/${icons[t].img}.svg" />`
									)
									.join("");
								let content = `${svgs} ${name}: ${start}${end}`;

								if (url) {
									content = `<a href="${url}" target="_blank">${content}</a>`;
								}

								return `<li>${content}</li>`;
							}
						);

						conferenceList.innerHTML = eventItems.join("");
					} else {
						conferences.innerHTML = `<p>Be right back, taking a much needed break</p>`;
					}
				});

			fetch(`${api}/travel`)
				.then((res) => res.json())
				.then((res) => {
					if (res.length) {
						trips.innerHTML = "<ul></ul>";

						const tripsList = trips.querySelector("ul"),
							tripItems = res.map(
								({ country_code, country, city, start, end }) =>
									`<li><img alt="Flag of ${country}" src="/img/countries/${country_code}.svg" />${city}, ${country}: ${start}${end}</li>`
							);

						tripsList.innerHTML = tripItems.join("");
					} else {
						trips.innerHTML =
							"<p>Nothing right now, I guess the suitcase can actually go away this time...</p>";
					}
				});

			fetch(`${api}/current`)
				.then((res) => res.json())
				.then(
					({
						country,
						city,
						country_code,
						eventType,
						conference,
						eventUrl,
					}) => {
						location.innerHTML = `<img alt="Flag of ${country}" src="/img/countries/${country_code}.svg" /> ${city}, ${country}`;

						let conferenceInfo = `${conference}`;

						if (eventType) {
							conferenceInfo = `${eventType
								.map(
									(t) =>
										`<img alt="${icons[t].alt}" src="/img/icons/${icons[t].img}.svg" />`
								)
								.join("")} ${conferenceInfo}`;
						}

						if (eventUrl) {
							conferenceInfo = `<a href="${eventUrl}" target="_blank">${conferenceInfo}</a>`;
						}

						currentConference.innerHTML = conferenceInfo;
					}
				);
		}
	}
</script>
